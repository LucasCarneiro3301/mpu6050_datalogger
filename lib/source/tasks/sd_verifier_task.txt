#include "globals.h"
#include "tasks.h"
#include "sd_utils.h"
#include <math.h>

void vSDVerifier(void *params)
{
    while (true)
    {
        if ((xSemaphoreTake(xDisplayMut, portMAX_DELAY)==pdTRUE))
        {
            if(sd_status == 0) {
                printf("\nMontando o SD...\n");
                ssd1306_fill(&ssd, false);                              // Limpa o display
                ssd1306_rect(&ssd, 3, 3, 122, 60, true, false);         // Desenha um retângulo
                ssd1306_draw_string(&ssd, "Montando", 30, 20);          // Escreve texto no display
                ssd1306_draw_string(&ssd, "Cartao SD...", 20, 32);      // Escreve texto no display
                ssd1306_send_data(&ssd);                                // Atualiza o display

                gpio_put(GREEN, true);
                gpio_put(RED, true);

                int res = run_mount(); // Montando cartão SD

                busy_wait_ms(2000);

                if(res==1) {
                    sd_status = 1;

                    gpio_put(RED, false);

                    ssd1306_fill(&ssd, false);                              // Limpa o display
                    ssd1306_rect(&ssd, 3, 3, 122, 60, true, false);         // Desenha um retângulo
                    ssd1306_draw_string(&ssd, "Cartao SD", 30, 16);         // Escreve texto no display
                    ssd1306_draw_string(&ssd, "Montado com", 20, 28);       // Escreve texto no display
                    ssd1306_draw_string(&ssd, "sucesso!!!", 20, 40);        // Escreve texto no display
                    ssd1306_send_data(&ssd);                                // Atualiza o display

                    busy_wait_ms(2000);
                }
                else if(res < 1) {
                    gpio_put(GREEN, false);
                    
                    printf("\nErro ao montar o cartão SD...\n");
                    ssd1306_fill(&ssd, false);                                      // Limpa o display
                    ssd1306_rect(&ssd, 3, 3, 122, 60, true, false);                 // Desenha um retângulo
                    ssd1306_draw_string(&ssd, "ERRO!!!", 30, 20);                   // Escreve texto no display
                    ssd1306_draw_string(&ssd, "Tentando", 25, 32);                  // Escreve texto no display
                    ssd1306_draw_string(&ssd, "novamente...", 25, 44);              // Escreve texto no display
                    ssd1306_send_data(&ssd);                                        // Atualiza o display
                    
                    for(int i = 0; i < 10; i++) {
                        gpio_put(BLUE, (i+1)%2);
                        gpio_put(RED, (i+1)%2);

                        busy_wait_ms(200);
                    }
                }    
            } else {

            }

            xSemaphoreGive(xDisplayMut);
        }
        vTaskDelay(pdMS_TO_TICKS(5000));
    }
}